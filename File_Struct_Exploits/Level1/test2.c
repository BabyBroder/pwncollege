#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdint.h>
#include <stdlib.h>
#include <sys/stat.h>

#define _DWORD uint32_t
#define _QWORD uint64_t

int print_fp(char *a1)
{
    int i;

    puts("Here is the contents of the FILE structure.");
    printf("fp -> %p\n", a1);
    printf("0x00\t_flags \t\t\t*%p = 0x%x\n", a1, *(_DWORD *)a1);
    printf("0x08\t_IO_read_ptr \t\t*%p = %p\n", a1 + 8, *((const void **)a1 + 1));
    printf("0x10\t_IO_read_end \t\t*%p = %p\n", a1 + 16, *((const void **)a1 + 2));
    printf("0x18\t_IO_read_base \t\t*%p = %p\n", a1 + 24, *((const void **)a1 + 3));
    printf("0x20\t_IO_write_base \t\t*%p = %p\n", a1 + 32, *((const void **)a1 + 4));
    printf("0x28\t_IO_write_ptr \t\t*%p = %p\n", a1 + 40, *((const void **)a1 + 5));
    printf("0x30\t_IO_write_end \t\t*%p = %p\n", a1 + 48, *((const void **)a1 + 6));
    printf("0x38\t_IO_buf_base \t\t*%p = %p\n", a1 + 56, *((const void **)a1 + 7));
    printf("0x40\t_IO_buf_end \t\t*%p = %p\n", a1 + 64, *((const void **)a1 + 8));
    printf("0x48\t_IO_save_base \t\t*%p = %p\n", a1 + 72, *((const void **)a1 + 9));
    printf("0x50\t_IO_backup_base \t*%p = %p\n", a1 + 80, *((const void **)a1 + 10));
    printf("0x58\t_IO_save_end \t\t*%p = %p\n", a1 + 88, *((const void **)a1 + 11));
    printf("0x60\t_markers \t\t*%p = %p\n", a1 + 96, *((const void **)a1 + 12));
    printf("0x68\t_chain \t\t\t*%p = %p\n", a1 + 104, *((const void **)a1 + 13));
    printf("0x70\t_fileno \t\t*%p = %d\n", a1 + 112, *((_DWORD *)a1 + 28));
    printf("0x74\t_flags2 \t\t*%p = %d\n", a1 + 116, *((_DWORD *)a1 + 29));
    printf("0x78\t_old_offset \t\t*%p = %ld\n", a1 + 120, *((_QWORD *)a1 + 15));
    printf("0x80\t_cur_column \t\t*%p = %hd\n", a1 + 128, *((uint16_t *)a1 + 64));
    printf("0x82\t_vtable_offset \t\t*%p = %hhd\n", a1 + 130, a1[130]);
    printf("0x83\t_shortbuf \t\t*%p = %hhd\n", a1 + 131, (int8_t)a1[131]);
    printf("0x88\t_lock \t\t\t*%p = %p\n", a1 + 136, *((const void **)a1 + 17));
    printf("0x90\t_offset \t\t*%p = %ld\n", a1 + 144, *((_QWORD *)a1 + 18));
    printf("0x98\t_codecvt \t\t*%p = %p\n", a1 + 152, *((const void **)a1 + 19));
    printf("0xa0\t_wide_data \t\t*%p = %p\n", a1 + 160, *((const void **)a1 + 20));
    printf("0xa8\t_freeres_list \t\t*%p = %p\n", a1 + 168, *((const void **)a1 + 21));
    printf("0xb0\t_freeres_buf \t\t*%p = %p\n", a1 + 176, *((const void **)a1 + 22));
    printf("0xb8\t__pad5 \t\t\t*%p = %ld\n", a1 + 184, *((_QWORD *)a1 + 23));
    printf("0xc0\t_mode \t\t\t*%p = %d\n", a1 + 192, *((_DWORD *)a1 + 48));
    printf("0xc4\t_unused2[%lld] \t\t*%p = {", 20LL, a1 + 196);
    for (i = 0; i < 19LL; ++i)
        printf("%hhx:", a1[i + 196]);
    return printf("%hhx}\n", a1[215]);
}

int create_tmp_file()
{
    int fd;

    umask(0);
    fd = open("/tmp/babyfile.txt", 65, 438LL);
    if (fd < 0)
    {
        puts("Failed to create file");
        return -1;
    }
    write(fd, "FLAG{NOT_HAPPENING}\n", 0x14uLL);
    return close(fd);
}

int main(int argc, char **argv)
{
    int fd = open("/flag", O_RDONLY);
    if(fd < 0)
    {
        puts("Failed to open /flag");
        return -1;
    }
    char secrect_message[0x100];
    read(fd, secrect_message, 0x100);
    printf("secret_message is located at: %p\n", &secrect_message);
    // call fwrite on the file
    void *buf = malloc(256);
    // open a file
    FILE *file_pointer = fopen("/tmp/babyfile.txt", "w");
    print_fp((char *)file_pointer);
    printf("Overwriting file_pointer\n");

    // overwrite the file struct from stdin
    read(0, file_pointer, 0x1e0);
    print_fp((char *)file_pointer);
    puts("Calling fwrite\n");
    fwrite(buf, 1, 40, file_pointer);
    return 0;
}